version: v2
budget: ai2/oe-adapt
description: open-instruct-finetune-multinode-llama-3-tulu-v2
tasks:
  - name: open-instruct-finetune-multinode-llama-3
    replicas: 8
    leaderSelection: true
    hostNetworking: true
    propagateFailure: true
    synchronizedStartTimeout: 48h0m0s
    propagatePreemption: true
    image:
      beaker: jacobm/open-instruct-llama-3
    command: [
      '/bin/sh', '-c'
    ]
    arguments: ['
        unset CUDA_LAUNCH_BLOCKING && accelerate launch
              --mixed_precision bf16
              --num_machines 8
              --num_processes 64
              --machine_rank $BEAKER_REPLICA_RANK
              --main_process_ip $BEAKER_LEADER_REPLICA_HOSTNAME
              --main_process_port 29400
              --use_deepspeed
              --deepspeed_config_file ds_configs/stage3_no_offloading_accelerate.conf
              open_instruct/finetune.py
              --model_name_or_path /models/llama_3/8b/
              --use_flash_attn
              --tokenizer_name /models/llama_3/8b/
              --use_slow_tokenizer
              --train_file /data/tulu_v2_mix.jsonl
              --max_seq_length 2048
              --preprocessing_num_workers 16
              --per_device_train_batch_size 2
              --gradient_accumulation_steps 1
              --learning_rate 2e-5
              --lr_scheduler_type linear
              --warmup_ratio 0.03
              --weight_decay 0.
              --num_train_epochs 2
              --output_dir /output/
              --with_tracking
              --report_to tensorboard
              --logging_steps 1
              --seed 42
    ']
    envVars:
      - name: CUDA_DEVICE_ORDER
        value: PCI_BUS_ID
      - name: TRANSFORMERS_CACHE
        value: ./cache/
      - name: WANDB_PROJECT
        value: open-instruct
      - name: WANDB_WATCH
        value: false
      - name: WANDB_LOG_MODEL
        value: false
      - name: WANDB_DISABLED
        value: true
      - name: NCCL_NET
        value: IB
      - name: NCCL_DEBUG
        value: INFO
    datasets:
    - mountPath: /data
      source:
        weka: oe-adapt-default
      subPath: jacobm/tulu-3-dev/data
    - mountPath: /models
      source:
        weka: oe-adapt-default
      subPath: jacobm/models
    result:
      path: /output
    resources:
      gpuCount: 8
    context:
      priority: high
      preemptible: true
    constraints:
      cluster: [ai2/jupiter-cirrascale-2]