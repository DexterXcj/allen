version: v2
description: open-instruct-finetune-full-13B-data-mix-v2
tasks:
  - name: open-instruct-finetune-full-13B-data-mix-v2
    image:
      beaker: Yizhongw03/open-instruct-multi-node
    command: [
      '/bin/sh', '-c'
    ]
    arguments: ['
        accelerate launch
        --mixed_precision bf16
        --num_machines 1
        --num_processes 8
        --use_deepspeed
        --deepspeed_config_file ds_configs/stage3_no_offloading_accelerate.conf
        open_instruct/finetune.py
        --model_name_or_path /net/nfs.cirrascale/allennlp/yizhongw/hf_llama2_models/13B
        --tokenizer_name /net/nfs.cirrascale/allennlp/yizhongw/hf_llama2_models/13B
        --use_slow_tokenizer
        --train_file /net/nfs.cirrascale/allennlp/yizhongw/open-instruct-public/data/processed/tulu/tulu_v2_mix.jsonl
        --use_flash_attn
        --max_seq_length 2048
        --preprocessing_num_workers 64
        --per_device_train_batch_size 1
        --gradient_accumulation_steps 16
        --learning_rate 2e-5
        --lr_scheduler_type linear
        --warmup_ratio 0.03
        --weight_decay 0.
        --num_train_epochs 2
        --output_dir /output/
        --with_tracking
        --report_to wandb
        --checkpointing_steps epoch
        --logging_steps 1
    ']
    envVars:
      - name: CUDA_DEVICE_ORDER
        value: PCI_BUS_ID
      - name: TRANSFORMERS_CACHE
        value: ./cache/
      - name: WANDB_API_KEY
        secret: WANDB_API_KEY
      - name: WANDB_PROJECT
        value: open-instruct
      - name: WANDB_NAME
        value: open-instruct-finetune-full-13B-data-mix-v2
      - name: WANDB_WATCH
        value: false
      - name: WANDB_LOG_MODEL
        value: false
      - name: WANDB_DISABLED
        value: false
      - name: NCCL_NET
        value: IB
      - name: NCCL_DEBUG
        value: INFO
    datasets:
      - mountPath: /net/nfs.cirrascale
        source:
          hostPath: /net/nfs.cirrascale
    result:
      path: /output
    resources:
      gpuCount: 8
    context:
      priority: high
    constraints:
      cluster: [ai2/general-cirrascale-a100-80g-ib]